machine:
  timezone:
    Asia/Tokyo
  java:
    version: oraclejdk8
  environment:
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'
dependencies:
  pre:
    - mkdir -p $ANDROID_HOME/licenses
    - echo -e "e6b7c2ab7fa2298c15165e9583d0acf0b04a2232\n8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_HOME/licenses/android-sdk-license
    - echo y | android -s update sdk -u -a -t "tools"
    - echo y | android -s update sdk -u -a -t "platform-tools"
    - echo y | android -s update sdk -u -a -t "extra-android-m2repository"
    - echo y | android -s update sdk -u -a -t "extra-google-google_play_services"
    - echo y | android -s update sdk -u -a -t "extra-google-m2repository"
test:
  override:
    - ./gradlew testMockDebugUnitTest
    - emulator -avd circleci-android22 -no-audio -no-window:
        background: true
        parallel: true
    - circle-android wait-for-boot
    # sleepを挟んでおいたほうがテストが安定した
    - sleep 10
    - adb shell settings put global window_animation_scale 0
    - adb shell settings put global transition_animation_scale 0
    - adb shell settings put global animator_duration_scale 0
    - adb shell input keyevent 82
    - ./gradlew connectedMockDebugAndroidTest
    - cp -r app/build/reports/* $CIRCLE_TEST_REPORTS
  post:
    # テストレポートへのリンクをslackへ投げる
    - |
      curl -s -S -X POST --data-urlencode "payload={'channel': '#ci', 'username': 'circleci', \
      'text': 'test report :\n JUnit : \
      <https://$CIRCLE_BUILD_NUM-72186590-gh.circle-artifacts.com/0$CIRCLE_TEST_REPORTS/tests/mockDebug/index.html| \
      junit test report > \
      \nUI test : \
      <https://$CIRCLE_BUILD_NUM-72186590-gh.circle-artifacts.com/0$CIRCLE_TEST_REPORTS/androidTests/connected/flavors/MOCK/index.html| \
      Espresso test report > \
      (build $CIRCLE_BUILD_NUM)' }" $SLACK_TEST_HOOK >/dev/null